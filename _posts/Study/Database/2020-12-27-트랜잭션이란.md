---
layout: post
title: "트랜잭션이란?"
categories:
  - Study
  - Database
tags:
  - Database
created_at: 2020-12-27T18:27:00+09:00
modified_at: 2020-12-27T18:27:00+09:00
visible: true
---

## 트랜잭션이란?

* 데이터를 다루는 시스템(DBMS혹은 그 외 유사한 시스템)에서 사용하는 하나의 논리적인 단위이다.
* 트랜잭션은 가장 작은 단위이기 때문에 더 이상 쪼개질 수 없으며 연산의 수행 후 반드시 완료 또는 취소의 상태를 가진다.

* 1개의 SQL쿼리 ≠ 1개의 트랜잭션

* 가장 흔한 예로 드는 송금과정을 예로 들면 다음과 같다(A가 B에게 10만원 송금)

  1. A의 은행계좌 확인
  2. 10만원 이상인 경우 10만원을 A의 계좌에서 출금
  3. B의 계좌에 10만원 입금

  * 위의 예시에서 2는 성공적으로 수행되었지만 3은 어떠한 오류로 인해 실패했을 경우 데이터베이스에 그대로 기록이 된다면, A의 10만원은 그냥 사라져버리게 된다.

  * 즉, 1, 2, 3쿼리를 **송금**이라는 논리적인 단위로 묶고, 이 단위의 성공과 실패를 판단해야한다(부분적 성공, 부분적 실패는 없음)



## 트랜잭션의 상태(status)

1. 트랙잭션의 생성

   * 하나의 논리적 로직을 수행하는 트랜잭션이 생성된다.

   * 이 트랜잭션에 논리적 로직을 구성하는 쿼리문들이 담기게 된다.

     ex) 송금 트랜잭션을 조회, 출금, 입금에 해당하는 쿼리문으로 구성한다.

2. 트랜잭션의 수행

   ![image-20201227174552854](../../assets/img/2020-12-27-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98%EC%9D%B4%EB%9E%80/트랜잭션수행상태.png)

   1. 활동(Active)
      * 트랜잭션을 구성하는 쿼리가 순차적으로 실행되는 단계
      * 일부 쿼리는 성공, 일부 쿼리는 수행 대기중인 상태

   2. 부분 완료(Partial committed)

      * 트랜잭션을 구성하는 쿼리가 모두 성공적으로 수행된 상태.
      * 이때 Commit 명령어를 통해 트랜잭션 수행으로 변경된 데이터를 데이터베이스에 저장한다.

   3. 실패(Failed)

      * 쿼리 수행 도중 실패한 쿼리가 발생한 상태
      * 이때 Rollback 명령어를 통해 수행된 쿼리로 변경된 데이터를 원래대로 되돌린다.

      * 쿼리 수행을 통해 데이터 무결성 원칙에 위배되는 데이터가 저장되려 하는 경우에 발생한다.
      * 그 외에도 네트워크 오류, DBMS 오류, 너무 긴 쿼리 수행시간 등의 실패 원인이 존재한다.

   4. 완료(Committed)

      * 부분완료 상태에서 Commit 명령어를 통해 데이터가 데이터베이스에 영구적으로 저장된 상태

   5. 철회(Aborted)

      * 실패 상태에서 Rollback 명령어를 통해 트랜잭션 수행 이전의 데이터로 되돌려 놓은 상태



## ACID란?

> 트랜잭션이 제대로 수행되기 위해 지켜져야하는 4가지 원칙

### Atomicity(원자성)

* 트랜잭션을 구성하는 쿼리는 부분적으로 성공, 실패하여서는 안된다.
* 트랜잭션은 가장 작은 단위이며 더 이상 쪼개질 수 없기 때문에 모두 성공하거나 실패해야한다.

### Consistency(일관성)

* 트랜잭션이 수행되기 이전이나 수행된 이후나 데이터베이스는 항상 동일한 상태를 유지해야 한다.
* 즉, 트랜잭션으로 인해 데이터베이스에서 정의한 무결성에 위배되는 데이터가 존재해서는 안된다.

### Isolation(독립성)

* 트랜잭션 수행 시 다른 트랜잭션이 도중에 끼어들 수 없다.
* 이를 위해 데이터베이스에서는 Lock을 통해 트랜잭션이 사용중인 레코드에 다른 트랜잭션이 접근 할 수 없도록 한다.
* 트랜잭션이 수행되고 있는 레코드에 다른 트랜잭션이 끼어들어 데이터를 조작한다면 데이터 무결성이 손상될 수 있다.
  1. 10만원이 들어 있는 A의 계좌에서 5만원을 출금하려고 함.(A의 계좌 잔액 10만원)
  2. 이때 A의 월급을 이체하려는 트랜잭션이 끼어들어 300만원 입금 수행성공(A의 계좌 잔액 310만원)
  3. A의 계좌에서 5만원을 출금하려는 트랜잭션이 모종의 이유로 실패하여 출금 트랜잭션이 실행되기 전 상태로 롤백 실행(A의 계좌 잔액 10만원)
  4. 은행이 정의한 사용자 정의 무결성("송금받은 금액 만큼 계좌 잔액이 증가")이 손상되었다.
* 다만 독립성의 경우 데이터베이스의 성능에 큰 영향을 미치기 때문에 4가지 격리수준을 통해 유연히 처리하도록 되어있다.

### Durability(지속성)

* 수행이 완료된 트랜잭션은 로그에 기록되고 데이터베이스에 영구히 반영되어야 한다.