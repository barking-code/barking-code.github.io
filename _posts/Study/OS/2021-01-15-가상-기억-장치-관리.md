---
layout: post
title: "가상 기억 장치(Virtual Memory) 관리"
categories:
  - Study
  - OS
tags:
  - OS
created_at: 2021-01-15T01:15:00+09:00
modified_at: 2021-01-15T01:15:00+09:00
visible: true
---

## 가상 기억 장치 란?

> 프로세스에서 현재 사용되고 있지 않는 부분을 보조 기억 장치의 일부분에 탑재하여 가용 메모리 용량을 확보하는 기법이다.

* 기존에는 메모리 크기보다 큰 프로그램을 작성하기 위해서는 오버레이 기법을 사용해 프로그래머가 일일히 프로그램을 분할해서 작성해야했다.
* 메모리 크기보다 프로그램의 크기가 크기때문에 메모리의 물리 주소를 직접 할당 할 수 없어 가상 주소를 사용해야한다.
* 각 프로세스는 프로세서의 비트 수 크기에 맞는(32/64 => 2^32(4GB), 2^64(16EiB)) 가상 주소 공간을 갖고 물리 주소와 가상 주소를 맵핑하는 역할을 하는 MMU에 의해 실제로 메모리에 적재된다.
* 프로그램을 페이지 단위로 나누고 필요한 페이지만 가상 기억 장치에서 메모리로 올리는 작업을 수행하는데 동시에 여러 프로세스가 진행되므로 동일 프로세스에 의해 실행되어야하는 프로그램 코드가 연속적인 주소를 갖지 못할 수도 있다. 하지만 MMU에 의해 실제 물리 주소를 몰라도 연속적인 프로그램 코드 수행이 가능하다. 이를 **인위적 연속성**이라고 한다.

---

## 가상 기억 장치 관리

* 현재 수행중인 프로세스는 꼭 필요한 페이지(와 자주 쓰이는 페이지)를 제외한 나머지 페이지를 가상 기억 장치에 보관해 두었다가 필요한 페이지가 발생할 경우 메모리에 적재하여 사용하게 된다.
* 페이지 반입 과정은 다음과 같다.
  * 프로세스가 필요한 페이지가 발생할 경우 먼저 **페이지 테이블**에 접근해 필요한 페이지가 메모리에 적재되어 있는지 확인한다.
  * 필요한 페이지가 적재되어있지 않다면(page fault), 먼저 메모리 상에 사용 가능한 프레임의 사용권한을 얻는다.
    * 사용 가능한 프레임이 없는 경우 교체 정책에 의해 기존 페이지를 가상 기억 장치로 내린 후 프레임 사용 권한을 획득한다.
  * 페이지를 swap-in 하고 변경 사항을 페이지 테이블에 기록한다.



### 반입 정책

#### Demand paging

* 프로세스가 요구하는 페이지가 발생하는 경우 페이지를 가상 기억 장치로부터 메모리로 적재한다.
* 꼭 필요한 페이지만 메모리에 적재하기 때문에 메모리를 효율적으로 사용할 수 있다.

* 미리 적재해놓은 페이지가 없기 때문에 매번 요청에 의해 페이지를 적재해야한다.

#### Prepaging

* 현재 프로세스 수행 중에 앞으로 필요할 것으로 예상되는 페이지를 미리 메모리에 적재한다.
* 예측이 실패 할 경우 메모리의 가용량을 감소시킬 수 있다.
* 어떤 페이지가 필요할지 미리 예측하기 힘들다.



### 교체 정책

#### FIFO(First in First out)

* 현재 적재된 페이지 중에서 가장 먼저 적재된 페이지를 swap-out 한다.
* 가장 먼저 적재된 페이지가 자주 쓰일 가능성이 있기 때문에 효율성을 고려한 알고리즘은 아니다.

#### LRU(Least Recently Used)

* 가장 오랫동안 사용되지 않은 페이지를 swap-out 한다.
* 매번 페이지 사용 시마다 Time stamp를 기록해야한다.
* 가장 많이 사용되는 방식

#### LFU(Least Frequence Used)

* 현 시점에서 사용된 횟수가 가장 적은 페이지를 swap-out 한다.
* 가장 최근의 불러온 페이지의 경우 사용 횟수가 1이기 때문에 교체될 가능성이 매우 높다.

#### NRU(Not Used Recently)

* LRU와 유사한 알고리즘이다.
* 페이지의 참조, 변경을 기록하여 교체 정책을 세운다. 순서는 다음과 같다
  * 참조 0, 변경 0: 최근에 참조되지도 않고 변경되지도 않은 페이지
  * 참조 0, 변경 1: 참조된 적은 없으나 변경이 된 페이지
  * 참조 1, 변경 1: 참조된 적이 있으나 변경이 된 적은 없는 페이지
  * 참조 1, 변경 1: 참조와 변경 모두 발생한 페이지
* 시간이 흐르면 참조 비트가 모두 1이 되는 경우가 발생하기 때문에 주기적으로 참조 비트를 0으로 초기화시켜준다.

---

## 스레싱과 워킹 세트(Thrashing & Working Set)

### 스레싱

* 페이지 교체가 너무 자주 일어나는 현상을 스레싱이라고한다.
* 다수의 프로세스가 메모리를 공유하여 사용하는 상황에서 너무 많은 프로세스가 수행되는 경우 각 프로세스에 할당되는 세그먼트(메모리 할당량)이 적어지게 되는데, 프로세스 수행에 필요한 페이지를 충분히 적재하지 못하게 되어 page fault가 많이 발생하게 된다.
* 즉, 페이지 교체를 위한 오버헤드가 많이 발생해 정상적인 프로세스 수행이 어려워지는 상황을 의미한다.

* 이를 방지하기 위해 메모리 상에 **프로세스 수행에 필요한 페이지들**을 일정시간 이상 적재시켜놓아야 하는데 이를 워킹 세트라고 한다.

### 구역성

* 프로세스가 실행되는 동안 모든 페이지(구역)를 균일하게 참조하는 것이 아니라 특정 구역을 집중적으로 참조하는 특성
* 가상 기억 장치 관리(Prepaging 등)와 워킹 세트의 이론적 근거가 됨
* 시간 구역성과 공간 구역성으로 구분할 수 있다.
  * 시간 구역성: 최근 참조한 구역은 가까운 미래에도 다시 참조될 가능성이 높다.
    * for, while문, counting, totaling 등
  * 공간 구역성: 최근 참조한 구역의 주변 구간또한 참조될 가능성이 높다.
    * Array 순회 등

### 워킹 세트

* 프로세스가 수행되는 일정 시간동안 참조하는 페이지들의 집합

* 구역성 이론을 기반으로 프로세스 수행 중 자주 참조되는 페이지를 워킹 세트로 묶어 메모리에 적재되어 있는 시간을 일정 시간동안 보장해준다.
* 프로세스가 진행됨에 따라서 기존에 사용하던 워킹 세트에서 다수의 페이지들이 추가, 삭제되는데 이를 **전이**라고 하며 워킹 세트의 구성이 어느정도 일정해 지면 **안정상태**라고한다.